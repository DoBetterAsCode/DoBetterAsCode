project_name: dobetterascode
containers:
  localstack:
    image: localstack/localstack
    ports:
      - 4572:4572
      - 8080:8080
    environment:
      SERVICES: s3
      DOCKER_HOST: unix:///var/run/docker.sock
      DEBUG: "1"
      PORT_WEB_UI: "8080"
    volumes:
      - /tmp/localstack:/tmp/localstack
  infra:
    build_directory: .batect/infra
    volumes:
      - ./:/code
    working_directory: /code
    environment:
      AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
      AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
      TF_OPERATION: ${TF_OPERATION:-apply}
      # TF_LOG: 1
tasks:
  localstack-start:
    description: Start localstack
    group: localstack
    run:
      container: localstack
      command: localstack start
  terraform-local-apply:
    description: Apply Terraform project with mock backend (localstack)
    group: terraform
    dependencies:
      - localstack
    run:
      container: infra
      command: /code/infra/modules/low-test/run-localstack.sh
      environment:
        TF_VAR_env: test
        TERRAFORM_DIR: /code/infra/modules/low-test
  terraform-medium-test:
    description: Apply Terraform test project
    group: terraform
    run:
      container: infra
      command: /code/infra/modules/medium-test/run-awspec.sh
      working_directory: /code/infra/modules/medium-test
      environment:
        TF_VAR_env: test
        TERRAFORM_DIR: /code/infra/modules/medium-test
  terraform-apply:
    description: Apply Terraform project
    group: terraform
    run:
      container: infra
      command: /code/infra/run.sh
      working_directory: /code/project
      environment:
        TF_VAR_env: ${ENVIRONMENT:-dev}
        TERRAFORM_DIR: /code/infra/project
  terraform-destroy:
    description: Destroy Terraform project
    group: terraform
    run:
      container: infra
      command: /code/infra/run.sh
      working_directory: /code/project
      environment:
        TF_VAR_env: ${ENVIRONMENT:-dev}
        TERRAFORM_DIR: /code/infra/project
        TF_OPERATION: destroy
  terraform-tflint:
    description: Run TFLint
    group: terraform
    run:
      container: infra
      command: /code/infra/modules/low-test/run-tflint.sh
      working_directory: /code/infra/modules
      environment:
        TF_VAR_env: test
        TERRAFORM_DIR: /code/infra/modules/low-test